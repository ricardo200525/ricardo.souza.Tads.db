IDF0: https://drive.google.com/open?id=1ZlpNqExo9MuFp3zW88EHT0JlI6PKg84N&usp=drive_copy

Modelagem Conceitual (Diagrama ER): https://drive.google.com/open?id=1DOVVYvrSm2PQXi1hGh8dBpyl2Rpgik3u&usp=drive_copy

Modelagem Lógica (Modelo relacional): https://drive.google.com/open?id=1QAjmwsXPEAT-3rg_OQXtrm1w1QxvdIdn&usp=drive_copy

Modelagem Física no Oracle:

--Tabela alunoPaciente

CREATE TABLE alunoPaciente ( 
    alunoPacienteID     NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CPF                 CHAR(11)               UNIQUE NOT NULL,
    Curso               VARCHAR2(50)           NOT NULL,
    Matricula           VARCHAR2(10)           UNIQUE NOT NULL,
    nome                VARCHAR2(60)           NOT NULL,
    dataNascimento      DATE                   NOT NULL,
    telefone            VARCHAR2(15),
    EmailInstitucional  VARCHAR2(120),
    senhaHash           VARCHAR2(100),
    sexo                CHAR(1),
   
    Logradouro          VARCHAR2(100),
    Numero              VARCHAR2(10),
    Bairro              VARCHAR2(50),
    Cidade              VARCHAR2(50),
    CEP                 CHAR(8),
    CONSTRAINT chk_sexo CHECK (sexo IN ('M','F'))
);

-- Tabela Profissional
-- Cadastro de profissionais
CREATE TABLE Profissional (
    profissionalID   NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Especialidade    VARCHAR2(40)    NOT NULL,
    Nome             VARCHAR2(60)    NOT NULL,
    Cargo            VARCHAR2(40)    NOT NULL
);

--Tabela Setor
--Gestão dos setores do hospital
CREATE TABLE Setor (
    setorID      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nome         VARCHAR2(60) NOT NULL,
    Tipo         VARCHAR2(30)
);

--Tabela Leito
--Controle de leitos por setor
CREATE TABLE Leito (
    leitoID        NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    setorID        NUMBER(10) NOT NULL,
    Nome           VARCHAR2(60) NOT NULL,
    StatusLeito    VARCHAR2(20) DEFAULT 'livre' NOT NULL,
    CONSTRAINT fk_leito_setor FOREIGN KEY (setorID) REFERENCES Setor(setorID)
);

-- 1.5) Tabela Agendamento
-- Requisito: Agendamento de consultas
CREATE TABLE Agendamento (
    AgendamentoID     NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DataAgendada      DATE NOT NULL,
    HoraAgendada      VARCHAR2(20) NOT NULL,
    StatusAgendamento VARCHAR2(20) DEFAULT 'agendada'
        CHECK (StatusAgendamento IN ('agendada', 'realizada', 'cancelada')),
    Prioridade        VARCHAR2(30),
    AlunoPacienteID   NUMBER(10) NOT NULL,
    ProfissionalID    NUMBER(10) NOT NULL,
    CONSTRAINT fk_agendamento_alunoPaciente FOREIGN KEY (AlunoPacienteID) REFERENCES alunoPaciente(alunoPacienteID),
    CONSTRAINT fk_agendamento_profissional FOREIGN KEY (ProfissionalID) REFERENCES Profissional(profissionalID)
);

-- Tabela Atendimento
-- Requisito: Registro de atendimentos
CREATE TABLE atendimento (
    atendimentoID      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    profissionalID     NUMBER(10) NOT NULL,
    alunoPacienteID    NUMBER(10) NOT NULL,
    Observacoes        VARCHAR2(300),
    StatusAtendimento  VARCHAR2(20) DEFAULT 'em andamento' NOT NULL,
    InicioData         DATE NOT NULL,
    fimData            DATE,
    CONSTRAINT fk_atendimento_profissional FOREIGN KEY (profissionalID) REFERENCES Profissional(profissionalID),
    CONSTRAINT fk_atendimento_aluno       FOREIGN KEY (alunoPacienteID) REFERENCES alunoPaciente(alunoPacienteID)
);

--Tabela ExameSolicitado
CREATE TABLE ExameSolicitado (
    exameID           NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    atendimentoID     NUMBER(10) NOT NULL,
    tipoExame         VARCHAR2(50) NOT NULL,
    dataSolicitacao   DATE DEFAULT SYSDATE NOT NULL,
    statusExame       VARCHAR2(20) DEFAULT 'Solicitado' NOT NULL,
    CONSTRAINT fk_exame_atendimento FOREIGN KEY (atendimentoID) REFERENCES atendimento(atendimentoID)
);

--Tabela ResultadoExame
CREATE TABLE ResultadoExame (
    resultadoID       NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    descricaoExame    VARCHAR2(200),
    exameID           NUMBER(10) NOT NULL,
    dataResultado     DATE,
    CONSTRAINT fk_resultado_exame FOREIGN KEY (exameID) REFERENCES ExameSolicitado(exameID)
);

CREATE TABLE HISTORICOMEDICO (
    HistoricoID     NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    AlunoID         NUMBER(10) NOT NULL,
    DataRegistro    DATE DEFAULT SYSDATE NOT NULL,
    Descricao       VARCHAR2(1000) NOT NULL,
    ProfissionalID  NUMBER(10) NOT NULL,
    TipoRegistro    VARCHAR2(30) NOT NULL,


    CONSTRAINT fk_historico_aluno FOREIGN KEY (AlunoID) 
        REFERENCES alunoPaciente(alunoPacienteID),
        
    CONSTRAINT fk_historico_profissional FOREIGN KEY (ProfissionalID) 
        REFERENCES Profissional(profissionalID),


    CONSTRAINT chk_tipo_registro CHECK (TipoRegistro IN ('Consulta', 'Exame', 'Alta', 'Observação'))
);


--Tabela ConvenioEstudantil
CREATE TABLE ConvenioEstudantil (
    convenioID      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nomeConvenio    VARCHAR2(80) NOT NULL,
    desconto        NUMBER(3) DEFAULT 0 NOT NULL,
    CONSTRAINT chk_desconto_convenio CHECK (desconto IN (0,50,100))
);

--Tabela AlunoConvenio
CREATE TABLE AlunoConvenio (
    alunoConvenioID   NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    alunoPacienteID   NUMBER(10) NOT NULL,
    convenioID        NUMBER(10) NOT NULL,
    dataInicio        DATE NOT NULL,
    dataFim           DATE,
    CONSTRAINT fk_alunoconvenio_aluno FOREIGN KEY (alunoPacienteID) REFERENCES alunoPaciente(alunoPacienteID),
    CONSTRAINT fk_alunoconvenio_convenio FOREIGN KEY (convenioID) REFERENCES ConvenioEstudantil(convenioID)
);

-- Tabela Internacao
CREATE TABLE Internacao (
    internacaoID      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dataEntrada       DATE NOT NULL,
    dataSaida         DATE,
    motivo            VARCHAR2(300) NOT NULL,
    statusInternacao  VARCHAR2(20) DEFAULT 'Ativa' NOT NULL,
    alunoPacienteID   NUMBER(10) NOT NULL,
    leitoID           NUMBER(10) NOT NULL,
    CONSTRAINT chk_status_internacao CHECK (statusInternacao IN ('Ativa','Alta','Cancelada')),
    CONSTRAINT fk_internacao_aluno FOREIGN KEY (alunoPacienteID) REFERENCES alunoPaciente(alunoPacienteID),
    CONSTRAINT fk_internacao_leito FOREIGN KEY (leitoID) REFERENCES Leito(leitoID)
);

-- Tabela Faturamento
-- Controle financeiro
CREATE TABLE Faturamento (
    faturamentoID       NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    atendimentoID       NUMBER(10) NOT NULL,
    alunoPacienteID     NUMBER(10) NOT NULL,
    valorBase           NUMBER(10,2) NOT NULL,
    descontoPercentual  NUMBER(3)    NOT NULL,
    valorFinal          NUMBER(10,2) NOT NULL,
    dataFaturamento     DATE DEFAULT SYSDATE NOT NULL,
    statusFatura        VARCHAR2(20) DEFAULT 'pendente',
    CONSTRAINT fk_faturamento_atendimento FOREIGN KEY (atendimentoID) REFERENCES atendimento(atendimentoID),
    CONSTRAINT fk_faturamento_aluno FOREIGN KEY (alunoPacienteID) REFERENCES alunoPaciente(alunoPacienteID)
);

-- 1.13) Tabelas de Auditoria e Usuários
-- Requisito: Sistema de auditoria
CREATE TABLE usuarioSistema(
    usuarioID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    login VARCHAR2(150) NOT NULL,
    tipoUsuario VARCHAR2(30)
        CHECK (tipoUsuario IN ('Aluno', 'Profissional', 'Admin'))
);

CREATE TABLE AuditLog (
    auditLogID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dataHora DATE DEFAULT SYSDATE,
    descricao VARCHAR2(500) NOT NULL,
    operacao VARCHAR2(20) NOT NULL,
    usuarioID NUMBER NOT NULL,
    CONSTRAINT fk_audit_usuario FOREIGN KEY (usuarioID)
        REFERENCES usuarioSistema(usuarioID)
);


--  Inserts


-- Pacientes
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000001','Enfermagem','20230001','Alice Santos', DATE '2003-01-10', '11990000001','alice.santos@senac.edu.br','h1','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000002','Fisioterapia','20230002','Bruno Almeida', DATE '2002-02-20', '11990000002','bruno.almeida@senac.edu.br','h2','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000003','Medicina','20230003','Carla Souza', DATE '2001-03-15', '11990000003','carla.souza@senac.edu.br','h3','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000004','Odontologia','20230004','Diego Pereira', DATE '2000-04-05', '11990000004','diego.pereira@senac.edu.br','h4','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000005','Enfermagem','20230005','Elisa Rocha', DATE '1999-05-22', '11990000005','elisa.rocha@senac.edu.br','h5','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000006','Fisioterapia','20230006','Felipe Costa', DATE '2004-06-12', '11990000006','felipe.costa@senac.edu.br','h6','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000007','Nutrição','20230007','Gabriela Lima', DATE '2003-07-30', '11990000007','gabriela.lima@senac.edu.br','h7','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000008','Psicologia','20230008','Hugo Martins', DATE '2002-08-18', '11990000008','hugo.martins@senac.edu.br','h8','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000009','Biomedicina','20230009','Isabela Freitas', DATE '2001-09-09', '11990000009','isabela.freitas@senac.edu.br','h9','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000010','Enfermagem','20230010','Jorge Nogueira', DATE '2000-10-01', '11990000010','jorge.nogueira@senac.edu.br','h10','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000011','Medicina','20230011','Karla Mendes', DATE '1998-11-11', '11990000011','karla.mendes@senac.edu.br','h11','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000012','Fisioterapia','20230012','Lucas Barros', DATE '2002-12-02', '11990000012','lucas.barros@senac.edu.br','h12','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000013','Enfermagem','20230013','Mariana Alves', DATE '2001-01-21', '11990000013','mariana.alves@senac.edu.br','h13','F');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000014','Nutrição','20230014','Nicolas Duarte', DATE '1999-02-14', '11990000014','nicolas.duarte@senac.edu.br','h14','M');
INSERT INTO alunoPaciente (CPF, Curso, Matricula, nome, dataNascimento, telefone, EmailInstitucional, senhaHash, sexo) VALUES
('10000000015','Psicologia','20230015','Olivia Gomes', DATE '2003-03-03', '11990000015','olivia.gomes@senac.edu.br','h15','F');

-- Profissionais
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Enfermagem','Ana Costa','Enfermeira');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Cardiologia','Breno Silva','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Clínico Geral','Camila Rocha','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Radiologia','Daniel Ferreira','Técnico de Radiologia');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Laboratório','Ester Nunes','Técnico de Laboratório');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Fisioterapia','Fábio Lima','Fisioterapeuta');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Psicologia','Gisela Prado','Psicóloga');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Nutrição','Henrique Moreira','Nutricionista');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Odontologia','Ivana Marinho','Dentista');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Pediatria','João Barros','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Ortopedia','Karina Reis','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Neurologia','Leonardo Pinto','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Dermatologia','Marcos Teixeira','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Anestesiologia','Natália Cruz','Médico');
INSERT INTO Profissional (Especialidade, Nome, Cargo) VALUES ('Endocrinologia','Otávio Silva','Médico');

-- Agendamentos
INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
VALUES (DATE '2025-01-10','08:00','agendada','baixa',1,1);
INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
VALUES (DATE '2025-01-11','09:00','agendada','alta',2,2);
INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
VALUES (DATE '2025-01-12','10:00','realizada','baixa',3,3);
INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
VALUES (DATE '2025-01-13','11:00','cancelada','média',4,4);
INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
VALUES (DATE '2025-01-14','08:00','agendada','baixa',5,5);

-- Setores
INSERT INTO Setor (Nome, Tipo) VALUES ('Emergência','Atendimento');
INSERT INTO Setor (Nome, Tipo) VALUES ('UTI Adulto','Internação');
INSERT INTO Setor (Nome, Tipo) VALUES ('UTI Pediátrica','Internação');
INSERT INTO Setor (Nome, Tipo) VALUES ('Enfermaria 1','Apoio');
INSERT INTO Setor (Nome, Tipo) VALUES ('Enfermaria 2','Apoio');
INSERT INTO Setor (Nome, Tipo) VALUES ('Radiologia','Diagnóstico');
INSERT INTO Setor (Nome, Tipo) VALUES ('Laboratório','Diagnóstico');
INSERT INTO Setor (Nome, Tipo) VALUES ('Sala de Curativos','Atendimento');
INSERT INTO Setor (Nome, Tipo) VALUES ('Sala Vermelha','Emergência');
INSERT INTO Setor (Nome, Tipo) VALUES ('Internação Geral','Internação');

-- Leitos
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (2,'UTI-A1','livre');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (2,'UTI-A2','ocupado');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (3,'UTI-P1','livre');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (3,'UTI-P2','manutenção');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (4,'ENF-101','livre');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (4,'ENF-102','ocupado');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (10,'INT-201','livre');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (10,'INT-202','ocupado');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (1,'EMG-01','livre');
INSERT INTO Leito (setorID, Nome, StatusLeito) VALUES (1,'EMG-02','ocupado');

-- Atendimentos
INSERT INTO atendimento (profissionalID, alunoPacienteID, Observacoes, StatusAtendimento, InicioData, fimData) VALUES
(1, 1, 'Avaliação de rotina de Enfermagem.', 'em andamento', DATE '2025-11-20', NULL);
INSERT INTO atendimento (profissionalID, alunoPacienteID, Observacoes, StatusAtendimento, InicioData, fimData) VALUES
(6, 5, 'Sessão inicial de fisioterapia para dor lombar.', 'em andamento', DATE '2025-11-20', NULL);
INSERT INTO atendimento (profissionalID, alunoPacienteID, Observacoes, StatusAtendimento, InicioData, fimData) VALUES
(3, 10, 'Consulta de clínico geral, febre e tosse.', 'finalizado', DATE '2025-11-18', DATE '2025-11-18');
INSERT INTO atendimento (profissionalID, alunoPacienteID, Observacoes, StatusAtendimento, InicioData, fimData) VALUES
(7, 15, 'Sessão de aconselhamento psicológico.', 'em andamento', DATE '2025-11-20', NULL);
INSERT INTO atendimento (profissionalID, alunoPacienteID, Observacoes, StatusAtendimento, InicioData, fimData) VALUES
(2, 2, 'Dor no peito, encaminhado para exames.', 'finalizado', DATE '2025-11-15', DATE '2025-11-15');

-- Exames Solicitados
INSERT INTO ExameSolicitado (atendimentoID, tipoExame, statusExame) VALUES (3, 'Hemograma Completo', 'Solicitado');
INSERT INTO ExameSolicitado (atendimentoID, tipoExame, statusExame) VALUES (3, 'Raio-X de Tórax', 'Realizado');
INSERT INTO ExameSolicitado (atendimentoID, tipoExame, statusExame) VALUES (5, 'Eletrocardiograma (ECG)', 'Solicitado');

-- Resultados Exame
INSERT INTO ResultadoExame (descricaoExame, exameID, dataResultado) VALUES ('ECG sem alterações significativas.', 3, DATE '2025-11-16');

-- Convênios
INSERT INTO ConvenioEstudantil (nomeConvenio, desconto) VALUES ('Bolsa 0%', 0);
INSERT INTO ConvenioEstudantil (nomeConvenio, desconto) VALUES ('Bolsa 50%', 50);
INSERT INTO ConvenioEstudantil (nomeConvenio, desconto) VALUES ('Bolsa 100%', 100);
INSERT INTO ConvenioEstudantil (nomeConvenio, desconto) VALUES ('Bolsa 50%', 50);
INSERT INTO ConvenioEstudantil (nomeConvenio, desconto) VALUES ('Bolsa 0%', 0);

-- Associação Aluno-Convênio
INSERT INTO AlunoConvenio (alunoPacienteID, convenioID, dataInicio, dataFim) VALUES (1, 3, DATE '2023-08-01', NULL); -- Alice, 100%
INSERT INTO AlunoConvenio (alunoPacienteID, convenioID, dataInicio, dataFim) VALUES (5, 3, DATE '2023-01-01', NULL); -- Elisa, 100%
INSERT INTO AlunoConvenio (alunoPacienteID, convenioID, dataInicio, dataFim) VALUES (10, 1, DATE '2023-05-10', DATE '2024-05-10'); -- Jorge, 0% (inativo)
INSERT INTO AlunoConvenio (alunoPacienteID, convenioID, dataInicio, dataFim) VALUES (15, 2, DATE '2024-02-15', NULL); -- Olivia, 50%

-- Internações
INSERT INTO Internacao (dataEntrada, dataSaida, motivo, statusInternacao, alunoPacienteID, leitoID) VALUES
(DATE '2025-11-15', NULL, 'Suspeita de pneumonia, observação intensiva.', 'Ativa', 10, 3);
INSERT INTO Internacao (dataEntrada, dataSaida, motivo, statusInternacao, alunoPacienteID, leitoID) VALUES
(DATE '2025-11-10', DATE '2025-11-12', 'Crise de hipertensão, estabilização.', 'Alta', 2, 1);

-- Historico Medico

INSERT INTO HISTORICOMEDICO (AlunoID, DataRegistro, Descricao, ProfissionalID, TipoRegistro)
VALUES (1, SYSDATE - 5, 'Paciente relatou dores de cabeça frequentes.', 3, 'Consulta');

INSERT INTO HISTORICOMEDICO (AlunoID, DataRegistro, Descricao, ProfissionalID, TipoRegistro)
VALUES (1, SYSDATE - 5, 'Solicitado hemograma completo e tomografia.', 3, 'Exame');

-- Histórico para Bruno (ID 2)
INSERT INTO HISTORICOMEDICO (AlunoID, DataRegistro, Descricao, ProfissionalID, TipoRegistro)
VALUES (2, SYSDATE - 10, 'Paciente admitido com crise hipertensiva.', 2, 'Observação');

INSERT INTO HISTORICOMEDICO (AlunoID, DataRegistro, Descricao, ProfissionalID, TipoRegistro)
VALUES (2, SYSDATE - 8, 'Pressão estabilizada, paciente liberado para casa.', 2, 'Alta');

-- Histórico para Elisa (ID 5)
INSERT INTO HISTORICOMEDICO (AlunoID, DataRegistro, Descricao, ProfissionalID, TipoRegistro)
VALUES (5, SYSDATE, 'Sessão de fisioterapia para lombalgia realizada com sucesso.', 6, 'Consulta');


--  Views
-- Views para simplificar consultas
CREATE OR REPLACE VIEW vw_auditlog_usuario AS
SELECT
    a.auditLogID,
    a.dataHora,
    a.operacao,
    a.descricao,
    u.usuarioID,
    u.login,
    u.tipoUsuario
FROM AuditLog a
JOIN usuarioSistema u
    ON a.usuarioID = u.usuarioID;

--Triggers de Auditoria de Usuário
--  Sistema de auditoria (INSERT/UPDATE/DELETE)
CREATE OR REPLACE TRIGGER trg_usuarioSistema_insert
AFTER INSERT ON usuarioSistema
FOR EACH ROW
BEGIN
    INSERT INTO AuditLog (usuarioID, operacao, descricao)
    VALUES (:NEW.usuarioID, 'INSERT', 'Usuário criado: login=' || :NEW.login || ', tipoUsuario=' || :NEW.tipoUsuario);
END;
/

CREATE OR REPLACE TRIGGER trg_usuarioSistema_update
AFTER UPDATE ON usuarioSistema
FOR EACH ROW
BEGIN
    INSERT INTO AuditLog (usuarioID, operacao, descricao)
    VALUES (:OLD.usuarioID, 'UPDATE', 'Usuário atualizado: login_antigo=' || :OLD.login || ', login_novo=' || :NEW.login);
END;
/

CREATE OR REPLACE TRIGGER trg_usuarioSistema_delete
AFTER DELETE ON usuarioSistema
FOR EACH ROW
BEGIN
    INSERT INTO AuditLog (usuarioID, operacao, descricao)
    VALUES (:OLD.usuarioID, 'DELETE', 'Usuário removido: login=' || :OLD.login);
END;
/

--Trigger de Auditoria de Prontuário (Complementar)
CREATE OR REPLACE TRIGGER trg_audit_atendimento_update
AFTER INSERT OR UPDATE OF Observacoes, StatusAtendimento ON atendimento
FOR EACH ROW
BEGIN
    INSERT INTO AuditLog (usuarioID, operacao, descricao)
    VALUES (
        1, -- Assumindo ID 1 (Admin/Sistema) por falta de sessão
        'UPDATE',
        'Prontuário ID ' || :OLD.atendimentoID || ' alterado. Status Antigo: ' || :OLD.StatusAtendimento || ' Novo: ' || :NEW.StatusAtendimento
    );
END;
/

--Trigger de Faturamento Automático
-- Triggers para integridade complexa e automação
CREATE OR REPLACE TRIGGER trg_gera_faturamento  -- <--- VOCÊ ESQUECEU ESTA LINHA
AFTER INSERT OR UPDATE OF fimData ON atendimento
FOR EACH ROW
WHEN (NEW.fimData IS NOT NULL)
DECLARE
    v_desconto NUMBER(3) := 0;
    v_valorBase NUMBER(10,2) := 200;
    v_valorFinal NUMBER(10,2);
BEGIN
    BEGIN
        SELECT c.desconto INTO v_desconto
        FROM AlunoConvenio ac
        JOIN ConvenioEstudantil c ON c.convenioID = ac.convenioID
        WHERE ac.alunoPacienteID = :NEW.alunoPacienteID
          -- Nota: Ajuste na lógica de data para aceitar o momento exato da inserção
          AND ac.dataInicio <= :NEW.InicioData 
          AND (ac.dataFim IS NULL OR ac.dataFim >= :NEW.InicioData)
          AND ROWNUM = 1;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN v_desconto := 0;
    END;

    v_valorFinal := v_valorBase - (v_valorBase * (v_desconto / 100));

    INSERT INTO Faturamento (atendimentoID, alunoPacienteID, valorBase, descontoPercentual, valorFinal)
    VALUES (:NEW.atendimentoID, :NEW.alunoPacienteID, v_valorBase, v_desconto, v_valorFinal);
END;
/


-- 3.5) Pacote de Gestão (Procedures e Functions)
-- Requisito: Funções e pacotes para encapsular regras de negócio
CREATE OR REPLACE PACKAGE pkg_hospital_gestao AS
    -- Procedure: Cadastrar Paciente
    PROCEDURE prc_cadastrar_paciente(
        p_cpf IN VARCHAR2,
        p_nome IN VARCHAR2,
        p_dataNasc IN DATE,
        p_curso IN VARCHAR2,
        p_matricula IN VARCHAR2,
        p_sexo IN CHAR
    );
    -- Procedure: Agendar Consulta
    PROCEDURE prc_agendar_consulta(
        p_pacienteID IN NUMBER,
        p_profissionalID IN NUMBER,
        p_dataHora IN DATE,
        p_prioridade IN VARCHAR2
    );
    --Taxa de Ocupação
    FUNCTION fn_taxa_ocupacao_setor(p_setorID IN NUMBER) RETURN NUMBER;
END pkg_hospital_gestao;
/

CREATE OR REPLACE PACKAGE BODY pkg_hospital_gestao AS

    PROCEDURE prc_cadastrar_paciente(
        p_cpf IN VARCHAR2, p_nome IN VARCHAR2, p_dataNasc IN DATE,
        p_curso IN VARCHAR2, p_matricula IN VARCHAR2, p_sexo IN CHAR
    ) IS
    BEGIN
        INSERT INTO alunoPaciente (CPF, nome, dataNascimento, Curso, Matricula, sexo)
        VALUES (p_cpf, p_nome, p_dataNasc, p_curso, p_matricula, p_sexo);
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE_APPLICATION_ERROR(-20001, 'Erro ao cadastrar paciente: ' || SQLERRM);
    END prc_cadastrar_paciente;

    PROCEDURE prc_agendar_consulta(
        p_pacienteID IN NUMBER, p_profissionalID IN NUMBER,
        p_dataHora IN DATE, p_prioridade IN VARCHAR2
    ) IS
        v_conflito NUMBER;
    BEGIN
        --Verificar disponibilidade do médico
        SELECT COUNT(*) INTO v_conflito FROM Agendamento
        WHERE ProfissionalID = p_profissionalID
          AND DataAgendada = TRUNC(p_dataHora)
          AND HoraAgendada = TO_CHAR(p_dataHora, 'HH24:MI')
          AND StatusAgendamento IN ('agendada');

        IF v_conflito > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, 'Profissional indisponível neste horário.');
        END IF;

        INSERT INTO Agendamento (DataAgendada, HoraAgendada, StatusAgendamento, Prioridade, AlunoPacienteID, ProfissionalID)
        VALUES (TRUNC(p_dataHora), TO_CHAR(p_dataHora, 'HH24:MI'), 'agendada', p_prioridade, p_pacienteID, p_profissionalID);
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            ROLLBACK;
            RAISE;
    END prc_agendar_consulta;

    FUNCTION fn_taxa_ocupacao_setor(p_setorID IN NUMBER) RETURN NUMBER IS
        v_total NUMBER;
        v_ocupados NUMBER;
        v_taxa NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_total FROM Leito WHERE setorID = p_setorID;
        SELECT COUNT(*) INTO v_ocupados FROM Leito WHERE setorID = p_setorID AND StatusLeito = 'ocupado';
        IF v_total = 0 THEN RETURN 0; END IF;
        v_taxa := (v_ocupados / v_total) * 100;
        RETURN ROUND(v_taxa, 2);
    END fn_taxa_ocupacao_setor;
END pkg_hospital_gestao;
/

--Views Dependentes de Funções
--Relatórios Gerenciais e Histórico
CREATE OR REPLACE VIEW vw_relatorio_setor AS
SELECT 
    s.Nome AS Setor,
    COUNT(l.leitoID) AS Total_Leitos,
    pkg_hospital_gestao.fn_taxa_ocupacao_setor(s.setorID) || '%' AS Taxa_Ocupacao
FROM Setor s
LEFT JOIN Leito l ON s.setorID = l.setorID
GROUP BY s.setorID, s.Nome;

CREATE OR REPLACE VIEW vw_historico_paciente AS
SELECT 
    p.nome AS Paciente,
    a.InicioData,
    prof.Nome AS Profissional,
    prof.Especialidade,
    a.Observacoes,
    LISTAGG(e.tipoExame, ', ') WITHIN GROUP (ORDER BY e.tipoExame) AS Exames
FROM alunoPaciente p
JOIN atendimento a ON p.alunoPacienteID = a.alunoPacienteID
JOIN Profissional prof ON a.profissionalID = prof.profissionalID
LEFT JOIN ExameSolicitado e ON a.atendimentoID = e.atendimentoID
GROUP BY p.nome, a.InicioData, prof.Nome, prof.Especialidade, a.Observacoes;

SELECT 
    p.Nome AS Medico,
    p.Especialidade,
    COUNT(a.atendimentoID) AS Qtd_Atendimentos,
    TO_CHAR(SUM(f.valorFinal), 'L999G999D99') AS Receita_Gerada
FROM Profissional p
JOIN atendimento a ON p.profissionalID = a.profissionalID
LEFT JOIN Faturamento f ON a.atendimentoID = f.atendimentoID
WHERE a.StatusAtendimento = 'finalizado'
GROUP BY p.profissionalID, p.Nome, p.Especialidade
HAVING COUNT(a.atendimentoID) >= 1 -- Filtro: Apenas médicos com pelo menos 1 atendimento
ORDER BY SUM(f.valorFinal) DESC;



SELECT 
    ap.nome AS Paciente,
    ap.Curso,
    i.dataEntrada,
    s.Nome AS Setor_Internacao,
    (SELECT COUNT(*) FROM ExameSolicitado es 
     WHERE es.atendimentoID IN (SELECT a.atendimentoID FROM atendimento a WHERE a.alunoPacienteID = ap.alunoPacienteID)) AS Total_Exames_Historico
FROM alunoPaciente ap
JOIN Internacao i ON ap.alunoPacienteID = i.alunoPacienteID
JOIN Leito l ON i.leitoID = l.leitoID
JOIN Setor s ON l.setorID = s.setorID
WHERE i.statusInternacao = 'Ativa'
AND ap.alunoPacienteID IN (
    -- Subconsulta: Pacientes que fizeram exames nos últimos 30 dias
    SELECT a.alunoPacienteID
    FROM atendimento a
    JOIN ExameSolicitado ex ON a.atendimentoID = ex.atendimentoID
    WHERE ex.dataSolicitacao >= SYSDATE - 30);

